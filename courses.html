<div id="courses-content">
  <div class="courses-hero">
    <h1>Explore Our Courses</h1>
    <p>Enhance your skills with our expert-led courses</p>
  </div>

  <div class="courses-container">
    <div class="course-filters">
      <button class="filter-btn active">All Courses</button>
      <button class="filter-btn">Web Development</button>
      <button class="filter-btn">Mobile Development</button>
      <button class="filter-btn">Data Science</button>
      <button class="filter-btn">Design</button>
    </div>

    <div class="course-grid" id="courses-container">
      <div
        id="loading-message"
        style="text-align: center; width: 100%; padding: 2rem"
      >
        <p>Loading courses...</p>
      </div>
      <div
        id="no-courses-message"
        style="display: none; text-align: center; width: 100%; padding: 2rem"
      >
        <p>No courses available yet. Check back later!</p>
      </div>
    </div>
  </div>
</div>

<!-- Admin-only storage bridge -->
<script>
  const ADMIN_KEY = "elearn_admin_state_v1";

  function getAdminState() {
    try {
      return JSON.parse(localStorage.getItem(ADMIN_KEY) || "{}");
    } catch {
      return {};
    }
  }
  function toArray(x) {
    if (Array.isArray(x)) return x;
    if (x && typeof x === "object") return Object.values(x);
    return [];
  }
  function getCoursesStrict() {
    const s = getAdminState();
    return toArray(s.courses);
  }
  function purgeLegacyIfAdminExists() {
    if (localStorage.getItem(ADMIN_KEY)) {
      [
        "home",
        "courses",
        "bookmarks",
        "playlists",
        "shorts",
        "websites",
      ].forEach((k) => {
        try {
          localStorage.removeItem(k);
        } catch {}
      });
    }
  }
</script>

<!-- Single loader script (no duplicates) -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // prevent double init if the page is injected twice
    if (document.body.dataset.coursesInitialized === "1") return;
    document.body.dataset.coursesInitialized = "1";

    purgeLegacyIfAdminExists();

    const grid = document.getElementById("courses-container");
    const loadingNode = document.getElementById("loading-message");
    const emptyNode = document.getElementById("no-courses-message");
    const filterButtons = document.querySelectorAll(".filter-btn");

    let allCourses = [];
    let currentFilter = "All Courses";

    function dedupeById(arr) {
      const seen = new Set();
      return arr.filter((c) => {
        const id = c.id || JSON.stringify([c.title, c.instructor, c.category]);
        if (seen.has(id)) return false;
        seen.add(id);
        return true;
      });
    }

    function clearCards() {
      Array.from(grid.children)
        .filter(
          (n) => !["loading-message", "no-courses-message"].includes(n.id)
        )
        .forEach((n) => n.remove());
    }

    function render(list) {
      clearCards();
      // hide empty by default
      emptyNode.style.display = "none";

      if (!list.length) {
        emptyNode.style.display = "block";
        return;
      }

      list.forEach((course, index) => {
        const sig = index; // stable per render
        const img =
          course.image ||
          `https://source.unsplash.com/600x400/?${encodeURIComponent(
            course.category || "learning"
          )}&sig=${sig}`;
        const card = document.createElement("div");
        card.className = "course-card";
        card.innerHTML = `
          <div class="course-thumbnail" style="background-image:url('${img}')">
            <i class="fas fa-graduation-cap"></i>
          </div>
          <div class="course-content">
            <span class="course-category">${course.category || "General"}</span>
            <h3 class="course-title">${course.title || "Untitled Course"}</h3>
            <p>${course.description || "No description available."}</p>
            <div class="course-meta">
              <span><i class="fas fa-chalkboard-teacher"></i> ${
                course.instructor || "Admin"
              }</span>
              <span><i class="fas fa-star"></i> ${
                course.status || "Draft"
              }</span>
            </div>
            <div class="course-footer">
              <button class="btn-enroll">View Details</button>
            </div>
          </div>`;
        grid.appendChild(card);
      });
    }

    function applyFilter(catText) {
      currentFilter = catText;
      if (catText === "All Courses") return render(allCourses);
      const filtered = allCourses.filter(
        (c) => (c.category || "").toLowerCase() === catText.toLowerCase()
      );
      render(filtered);
    }

    function load() {
      // show loader (and make sure text is visible while fetching)
      if (loadingNode) loadingNode.style.display = "block";
      emptyNode.style.display = "none";

      // read admin-only, dedupe, then draw
      let list = getCoursesStrict();
      list = dedupeById(list);

      // remove loader node entirely so it can never occupy grid space again
      loadingNode?.remove();

      allCourses = list;
      applyFilter(currentFilter);
    }

    // Filters
    filterButtons.forEach((btn) => {
      btn.addEventListener("click", function () {
        filterButtons.forEach((b) => b.classList.remove("active"));
        this.classList.add("active");
        applyFilter(this.textContent.trim());
      });
    });

    // Live updates when Admin changes
    window.addEventListener("storage", (e) => {
      if (e.key === ADMIN_KEY) {
        purgeLegacyIfAdminExists();
        let list = getCoursesStrict();
        list = dedupeById(list);
        allCourses = list;
        applyFilter(currentFilter);
      }
    });

    load();
  });
</script>

<style>
  .courses-hero {
    background: linear-gradient(135deg, #49bbbd, #2c3e50);
    color: white;
    padding: 3rem 2rem;
    text-align: center;
    margin-bottom: 2rem;
    border-radius: 8px;
  }
  .courses-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 1rem;
  }
  .course-filters {
    display: flex;
    gap: 1rem;
    margin-bottom: 2rem;
    flex-wrap: wrap;
  }
  .filter-btn {
    padding: 0.5rem 1.5rem;
    border: 1px solid #ddd;
    background: #fff;
    border-radius: 20px;
    cursor: pointer;
    transition: all 0.3s;
  }
  .filter-btn:hover,
  .filter-btn.active {
    background: #49bbbd;
    color: #fff;
    border-color: #49bbbd;
  }

  .course-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 2rem;
    margin-top: 2rem;
  }

  .course-card {
    background: #fff;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    transition: transform 0.3s;
  }
  .course-card:hover {
    transform: translateY(-5px);
  }

  .course-thumbnail {
    height: 160px;
    background: #f5f7fa;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 3rem;
    color: #49bbbd;
    position: relative;
  }
  .course-content {
    padding: 1.5rem;
  }
  .course-category {
    color: #49bbbd;
    font-size: 0.9rem;
    margin-bottom: 0.5rem;
    display: block;
  }
  .course-title {
    font-size: 1.25rem;
    margin: 0.5rem 0;
  }
  .course-meta {
    display: flex;
    justify-content: space-between;
    color: #666;
    font-size: 0.9rem;
    margin: 1rem 0;
  }
  .course-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: 1rem;
    border-top: 1px solid #eee;
  }
  .btn-enroll {
    background: #49bbbd;
    color: #fff;
    border: none;
    padding: 0.5rem 1.5rem;
    border-radius: 5px;
    cursor: pointer;
    transition: background 0.3s;
  }
  .btn-enroll:hover {
    background: #3aa8aa;
  }
</style>
