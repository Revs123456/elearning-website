<div id="websites-content">
  <div class="websites-container">
    <div class="websites-header">
      <h2>Learning Resources</h2>
      <p>Discover and organize your favorite learning resources</p>
    </div>

    <div class="search-container">
      <div class="search-box">
        <i class="fas fa-search"></i>
        <input
          id="search-websites"
          type="text"
          placeholder="Search websites, tutorials, and more..."
        />
      </div>
      <div class="filter-group">
        <select id="category-filter" class="filter-select">
          <option value="">All Categories</option>
          <option value="education">Education</option>
          <option value="productivity">Productivity</option>
          <option value="development">Development</option>
          <option value="design">Design</option>
          <option value="other">Other</option>
        </select>
      </div>
    </div>

    <!-- Loading -->
    <div id="loading-state" class="loading-state">
      <div class="spinner"></div>
      <p>Loading resources...</p>
    </div>

    <!-- Empty -->
    <div id="empty-state" class="empty-state" style="display: none">
      <i class="fas fa-globe"></i>
      <h3>No Resources Found</h3>
      <p>Currently there are no resources to display.</p>
    </div>

    <!-- Grid -->
    <div id="websites-grid" class="websites-grid"></div>
  </div>
</div>

<style>
  .websites-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 1rem;
  }
  .websites-header {
    margin-bottom: 2rem;
  }
  .search-container {
    display: flex;
    gap: 1rem;
    margin-bottom: 2rem;
    flex-wrap: wrap;
  }
  .search-box {
    flex: 1;
    min-width: 300px;
    position: relative;
  }
  .search-box i {
    position: absolute;
    left: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: #666;
  }
  .search-box input {
    width: 100%;
    padding: 0.75rem 1rem 0.75rem 2.5rem;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 0.95rem;
  }
  .filter-group {
    min-width: 200px;
  }
  .filter-select {
    width: 100%;
    padding: 0.75rem 1rem;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 0.95rem;
    background: #fff;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%237f8c8d' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 0.75rem center;
    padding-right: 2.5rem;
  }
  .websites-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1.5rem;
  }
  .website-card {
    display: flex;
    align-items: center;
    padding: 1.25rem;
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    transition: transform 0.3s, box-shadow 0.3s;
    text-decoration: none;
    color: #333;
  }
  .website-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
  }
  .website-icon {
    width: 50px;
    height: 50px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 1rem;
    flex-shrink: 0;
  }
  .website-icon i {
    font-size: 1.5rem;
    color: #fff;
  }
  .website-info {
    flex: 1;
  }
  .website-info h3 {
    margin: 0 0 0.25rem 0;
    font-size: 1.1rem;
  }
  .website-info p {
    margin: 0;
    color: #666;
    font-size: 0.9rem;
  }
  .website-category {
    display: inline-block;
    background: #e9f9f9;
    color: #49bbbd;
    font-size: 0.75rem;
    padding: 0.25rem 0.75rem;
    border-radius: 15px;
    margin-top: 0.5rem;
  }
  .external-link {
    color: #999;
    margin-left: 0.5rem;
    transition: color 0.3s;
  }
  .website-card:hover .external-link {
    color: #49bbbd;
  }

  .loading-state {
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 3rem 0;
    color: #7f8c8d;
  }
  .spinner {
    border: 4px solid rgba(0, 0, 0, 0.1);
    width: 36px;
    height: 36px;
    border-radius: 50%;
    border-left-color: #49bbbd;
    animation: spin 1s linear infinite;
    margin-bottom: 1rem;
  }
  @keyframes spin {
    0% {
      transform: rotate(0);
    }
    100% {
      transform: rotate(360deg);
    }
  }
  .empty-state {
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 4rem 2rem;
    background: #f9f9f9;
    border-radius: 8px;
    margin: 2rem 0;
  }
  .empty-state i {
    font-size: 3rem;
    color: #e0e0e0;
    margin-bottom: 1rem;
  }
</style>

<script>
  // ---- keys
  const ADMIN_KEY = "elearn_admin_state_v1";
  const LEGACY_KEY = "websites";

  // ---- helpers
  function parseJSON(key, fallback) {
    try {
      return JSON.parse(localStorage.getItem(key) || fallback);
    } catch {
      return JSON.parse(fallback);
    }
  }
  function getAdminState() {
    return parseJSON(ADMIN_KEY, "{}");
  }
  function toArray(x) {
    if (Array.isArray(x)) return x;
    if (x && typeof x === "object") return Object.values(x);
    return [];
  }
  // Merge admin + legacy, not either/or
  function getAllWebsites() {
    const adminArr = toArray(getAdminState().websites);
    const legacyArr = toArray(parseJSON(LEGACY_KEY, "[]"));
    // merge & dedupe by (id || url)
    const out = [];
    const seen = new Set();
    [...adminArr, ...legacyArr].forEach((w) => {
      const key = (w?.id || "") + "::" + (w?.url || "");
      if (!seen.has(key)) {
        seen.add(key);
        out.push(w);
      }
    });
    return out;
  }
  function normalizeUrl(u) {
    if (!u) return "";
    if (/^https?:\/\//i.test(u)) return u;
    return "https://" + u; // safe default
  }
  function getFavicon(url) {
    if (!url) return "fas fa-globe";
    try {
      const h = new URL(normalizeUrl(url)).hostname;
      if (h.includes("github.com")) return "fab fa-github";
      if (h.includes("youtube.com")) return "fab fa-youtube";
      if (h.includes("twitter.com")) return "fab fa-twitter";
      if (h.includes("linkedin.com")) return "fab fa-linkedin";
      if (h.includes("stackoverflow.com")) return "fab fa-stack-overflow";
      if (h.includes("medium.com")) return "fab fa-medium";
      if (h.includes("codepen.io")) return "fab fa-codepen";
      if (h.includes("gitlab.com")) return "fab fa-gitlab";
      if (h.includes("bitbucket.org")) return "fab fa-bitbucket";
    } catch {}
    return "fas fa-globe";
  }
  function randColor() {
    const colors = [
      "#83d0f2",
      "#f48024",
      "#49bbbd",
      "#a67c52",
      "#6f42c1",
      "#e83e8c",
    ];
    return colors[Math.floor(Math.random() * colors.length)];
  }
  function formatCategory(c) {
    c = String(c || "");
    return c.charAt(0).toUpperCase() + c.slice(1);
  }

  document.addEventListener("DOMContentLoaded", () => {
    const grid = document.getElementById("websites-grid");
    const loading = document.getElementById("loading-state");
    const empty = document.getElementById("empty-state");
    const search = document.getElementById("search-websites");
    const category = document.getElementById("category-filter");

    let all = [];

    function render(list) {
      grid.innerHTML = "";
      if (!list.length) {
        empty.style.display = "flex";
        grid.style.display = "none";
        return;
      }
      empty.style.display = "none";
      grid.style.display = "grid";

      list.forEach((w) => {
        const url = normalizeUrl(w.url);
        let hostname = "";
        try {
          hostname = url ? new URL(url).hostname.replace("www.", "") : "";
        } catch {}
        const card = document.createElement("a");
        card.href = url || "#";
        card.target = "_blank";
        card.rel = "noopener";
        card.className = "website-card";
        card.innerHTML = `
          <div class="website-icon" style="background:${randColor()}">
            <i class="${getFavicon(url)}"></i>
          </div>
          <div class="website-info">
            <h3>${w.name || hostname || "Website"}</h3>
            <p>${w.description || "No description available"}</p>
            ${
              w.category
                ? `<span class="website-category">${formatCategory(
                    w.category
                  )}</span>`
                : ""
            }
          </div>
          <i class="fas fa-external-link-alt external-link"></i>
        `;
        grid.appendChild(card);
      });
    }

    function applyFilters() {
      const term = (search.value || "").toLowerCase();
      const cat = (category.value || "").toLowerCase();
      const filtered = all.filter((w) => {
        const matchesTerm =
          !term ||
          (w.name && String(w.name).toLowerCase().includes(term)) ||
          (w.description &&
            String(w.description).toLowerCase().includes(term)) ||
          (w.url && String(w.url).toLowerCase().includes(term));
        const matchesCat =
          !cat || (w.category && String(w.category).toLowerCase() === cat);
        return matchesTerm && matchesCat;
      });
      render(filtered);
    }

    function load() {
      loading.style.display = "flex";
      empty.style.display = "none";
      grid.innerHTML = "";
      setTimeout(() => {
        all = getAllWebsites();
        loading.style.display = "none";
        applyFilters();
      }, 120);
    }

    search.addEventListener("input", applyFilters);
    category.addEventListener("change", applyFilters);

    // live update when admin saves or legacy changes
    window.addEventListener("storage", (e) => {
      if (e.key === ADMIN_KEY || e.key === LEGACY_KEY) {
        all = getAllWebsites();
        applyFilters();
      }
    });

    load();
  });
</script>
