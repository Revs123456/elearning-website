<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Bookmarks</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
    <style>
      body {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu,
          "Helvetica Neue", Arial, sans-serif;
        background: #f7f8fb;
        color: #1f2937;
        margin: 0;
      }
      .wrap {
        max-width: 1100px;
        margin: 24px auto;
        padding: 0 16px;
      }
      .h1 {
        font-size: 32px;
        font-weight: 800;
        margin: 0 0 16px;
      }
      .toolbar {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        margin: 8px 0 20px;
      }
      .tab {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 0.6rem 1rem;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        background: #fff;
        cursor: pointer;
      }
      .tab.active {
        background: #1fb6b0;
        color: #fff;
        border-color: #1fb6b0;
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 16px;
      }
      .card {
        display: flex;
        align-items: center;
        gap: 12px;
        background: #fff;
        border: 1px solid #eef2f7;
        border-radius: 12px;
        padding: 14px 16px;
      }
      .icon {
        width: 38px;
        height: 38px;
        border-radius: 10px;
        background: #e6fbfb;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .icon i {
        color: #1fb6b0;
      }
      .title {
        font-weight: 700;
        margin: 0 0 4px;
      }
      .meta {
        font-size: 12px;
        color: #9aa3af;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .chip {
        margin-left: auto;
        background: #e9f9f9;
        color: #1fb6b0;
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 12px;
      }
      .ghost {
        border: none;
        background: transparent;
        cursor: pointer;
      }
      .ghost i {
        color: #9aa3af;
      }
      .ghost:hover i {
        color: #ef4444;
      }
      .empty {
        color: #6b7280;
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <h1 class="h1">Bookmarks</h1>
      <div class="toolbar" id="tabs">
        <button class="tab" data-tab="courses">
          <i class="fas fa-graduation-cap"></i>Courses
        </button>
        <button class="tab" data-tab="playlists">
          <i class="fas fa-list"></i>Playlists
        </button>
        <button class="tab" data-tab="shorts">
          <i class="fas fa-video"></i>Shorts
        </button>
        <button class="tab" data-tab="websites">
          <i class="fas fa-globe"></i>Websites
        </button>
        <button class="tab active" data-tab="all">
          <i class="fas fa-layer-group"></i>All
        </button>
      </div>

      <div id="grid" class="grid"></div>
      <p id="empty" class="empty" style="display: none">No bookmarks found.</p>
    </div>

    <script>
      const ADMIN_KEY = "elearn_admin_state_v1";

      // --- admin state helpers
      function readState() {
        try {
          return JSON.parse(localStorage.getItem(ADMIN_KEY) || "{}");
        } catch {
          return {};
        }
      }
      function writeState(s) {
        localStorage.setItem(ADMIN_KEY, JSON.stringify(s));
        try {
          window.dispatchEvent(new StorageEvent("storage", { key: ADMIN_KEY }));
        } catch {}
      }

      // migrate old/legacy bookmarks to have a lowercase category and map "general" (courses) to "courses"
      function migrateBookmarks() {
        const s = readState();
        const arr = Array.isArray(s.bookmarks) ? s.bookmarks : [];
        let changed = false;
        arr.forEach((b) => {
          const before = b.category;
          let cat = String(b.category || "")
            .toLowerCase()
            .trim();
          if (!cat && b.meta && b.meta.courseId) cat = "courses";
          if (cat === "general" && (b.meta?.courseId || (b.title && !b.url)))
            cat = "courses";
          if (cat !== before) {
            b.category = cat;
            changed = true;
          }
        });
        if (changed) {
          s.bookmarks = arr;
          writeState(s);
        }
        return Array.isArray(readState().bookmarks)
          ? readState().bookmarks
          : [];
      }

      // dedupe by _id (or by title+url fallback)
      function dedupe(list) {
        const seen = new Set();
        return list.filter((b) => {
          const key =
            b._id || `${b.title || ""}|${b.url || ""}|${b.category || ""}`;
          if (seen.has(key)) return false;
          seen.add(key);
          return true;
        });
      }

      function removeBookmark(bm) {
        const s = readState();
        const list = Array.isArray(s.bookmarks) ? s.bookmarks : [];
        const key =
          bm._id || `${bm.title || ""}|${bm.url || ""}|${bm.category || ""}`;
        s.bookmarks = list.filter((x) => {
          const k =
            x._id || `${x.title || ""}|${x.url || ""}|${x.category || ""}`;
          return k !== key;
        });
        writeState(s);
        render(currentTab); // refresh
      }

      function iconFor(b) {
        const c = (b.category || "").toLowerCase();
        if (c === "courses") return "fa-graduation-cap";
        if (c === "playlists") return "fa-list";
        if (c === "shorts") return "fa-video";
        if (c === "websites") return "fa-globe";
        return "fa-bookmark";
      }

      function shouldShowUrl(url) {
        if (!url) return false;
        const u = String(url).trim();
        if (u === "#" || u === "javascript:void(0)") return false;
        return /^https?:\/\//i.test(u);
      }

      // UI
      const grid = document.getElementById("grid");
      const empty = document.getElementById("empty");
      const tabs = document.getElementById("tabs");
      let currentTab = "all";

      function render(tab = "all") {
        currentTab = tab;
        const all = migrateBookmarks();
        const list = dedupe(all).filter((b) => {
          if (tab === "all") return true;
          return (b.category || "").toLowerCase() === tab;
        });

        grid.innerHTML = "";
        if (!list.length) {
          empty.style.display = "block";
          return;
        }
        empty.style.display = "none";

        list.forEach((b) => {
          const card = document.createElement("div");
          card.className = "card";

          card.innerHTML = `
          <div class="icon"><i class="fas ${iconFor(b)}"></i></div>
          <div style="flex:1;min-width:0">
            <div class="title">${b.title || b.name || "Untitled"}</div>
            ${
              shouldShowUrl(b.url)
                ? `<div class="meta"><a href="${b.url}" target="_blank" rel="noopener">${b.url}</a></div>`
                : ``
            }
          </div>
          ${
            b.category
              ? `<span class="chip">${(b.category || "").toLowerCase()}</span>`
              : ``
          }
          <button class="ghost" title="Remove"><i class="fas fa-trash"></i></button>
        `;

          card
            .querySelector(".ghost")
            .addEventListener("click", () => removeBookmark(b));
          grid.appendChild(card);
        });
      }

      // tab clicks
      tabs.addEventListener("click", (e) => {
        const t = e.target.closest(".tab");
        if (!t) return;
        tabs
          .querySelectorAll(".tab")
          .forEach((b) => b.classList.remove("active"));
        t.classList.add("active");
        render(t.dataset.tab);
      });

      // init
      document.addEventListener("DOMContentLoaded", () => {
        render("all");
      });

      // live updates from other pages (add/remove)
      window.addEventListener("storage", (e) => {
        if (e.key === ADMIN_KEY) render(currentTab);
      });
    </script>
  </body>
</html>
